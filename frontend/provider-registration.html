<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X402 Provideræ³¨å†Œ - ä¸€é”®å¼€é€šä¿é™©æœåŠ¡</title>
    <!-- ä¿®å¤ethersåŠ è½½é—®é¢˜ï¼Œä½¿ç”¨æ›´ç¨³å®šçš„CDN -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 16px;
        }

        .status-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            font-size: 14px;
        }

        .status-item:last-child {
            margin-bottom: 0;
        }

        .status-label {
            color: #666;
        }

        .status-value {
            font-weight: 600;
            color: #333;
        }

        .tier-badges {
            display: flex;
            justify-content: space-around;
            margin: 25px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
        }

        .tier-badge {
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .tier-badge.active {
            background: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: scale(1.1);
        }

        .tier-icon {
            font-size: 32px;
            margin-bottom: 5px;
        }

        .tier-name {
            font-size: 12px;
            color: #666;
            font-weight: 600;
        }

        .tier-amount {
            font-size: 11px;
            color: #999;
            margin-top: 3px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
            font-size: 14px;
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .amount-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .amount-btn {
            flex: 1;
            padding: 8px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .amount-btn:hover {
            border-color: #667eea;
            background: #f8f9fa;
        }

        .amount-btn.selected {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 12px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .btn-secondary:hover {
            background: #f8f9fa;
        }

        .alert {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .alert-info {
            background: #e3f2fd;
            color: #1976d2;
            border: 1px solid #90caf9;
        }

        .alert-success {
            background: #e8f5e9;
            color: #388e3c;
            border: 1px solid #81c784;
        }

        .alert-error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ef9a9a;
        }

        .alert-warning {
            background: #fff3e0;
            color: #f57c00;
            border: 1px solid #ffcc80;
        }

        .steps {
            margin: 25px 0;
        }

        .step {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            opacity: 0.4;
            transition: opacity 0.3s;
        }

        .step.active {
            opacity: 1;
        }

        .step.completed {
            opacity: 1;
        }

        .step-number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #e0e0e0;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-weight: 600;
            font-size: 14px;
        }

        .step.active .step-number {
            background: #667eea;
        }

        .step.completed .step-number {
            background: #4caf50;
        }

        .step-text {
            font-size: 14px;
            color: #666;
        }

        .step.active .step-text {
            color: #333;
            font-weight: 500;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        .provider-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
        }

        .provider-info h3 {
            margin-bottom: 15px;
            font-size: 18px;
        }

        .provider-stat {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .provider-stat-value {
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ›¡ï¸ X402 Provideræ³¨å†Œ</h1>
        <p class="subtitle">ä¸€é”®å¼€é€šä¿é™©æœåŠ¡ï¼Œè®©æ‚¨çš„APIæ›´å¯ä¿¡</p>

        <!-- è¿æ¥é’±åŒ…éƒ¨åˆ† -->
        <div id="connectSection">
            <div class="alert alert-info">
                ğŸ‘‹ æ¬¢è¿ï¼è¯·å…ˆè¿æ¥æ‚¨çš„é’±åŒ…ä»¥å¼€å§‹æ³¨å†Œæµç¨‹
            </div>

            <button id="connectBtn" class="btn btn-primary">
                è¿æ¥é’±åŒ… (MetaMask)
            </button>

            <div class="steps">
                <div class="step active">
                    <div class="step-number">1</div>
                    <div class="step-text">è¿æ¥é’±åŒ…</div>
                </div>
                <div class="step">
                    <div class="step-number">2</div>
                    <div class="step-text">é€‰æ‹©å……å€¼é‡‘é¢</div>
                </div>
                <div class="step">
                    <div class="step-number">3</div>
                    <div class="step-text">å®Œæˆæ³¨å†Œ</div>
                </div>
            </div>
        </div>

        <!-- æ³¨å†Œéƒ¨åˆ† -->
        <div id="registerSection" class="hidden">
            <div class="status-card">
                <div class="status-item">
                    <span class="status-label">é’±åŒ…åœ°å€</span>
                    <span class="status-value" id="walletAddress">-</span>
                </div>
                <div class="status-item">
                    <span class="status-label">ç½‘ç»œ</span>
                    <span class="status-value" id="networkName">-</span>
                </div>
                <div class="status-item">
                    <span class="status-label">USDCä½™é¢</span>
                    <span class="status-value" id="usdcBalance">-</span>
                </div>
            </div>

            <div class="tier-badges">
                <div class="tier-badge" data-tier="bronze">
                    <div class="tier-icon">ğŸ¥‰</div>
                    <div class="tier-name">Bronze</div>
                    <div class="tier-amount">100-500</div>
                </div>
                <div class="tier-badge" data-tier="silver">
                    <div class="tier-icon">ğŸ¥ˆ</div>
                    <div class="tier-name">Silver</div>
                    <div class="tier-amount">500-1000</div>
                </div>
                <div class="tier-badge" data-tier="gold">
                    <div class="tier-icon">ğŸ¥‡</div>
                    <div class="tier-name">Gold</div>
                    <div class="tier-amount">1000-5000</div>
                </div>
                <div class="tier-badge" data-tier="platinum">
                    <div class="tier-icon">ğŸ’</div>
                    <div class="tier-name">Platinum</div>
                    <div class="tier-amount">5000+</div>
                </div>
            </div>

            <div class="input-group">
                <label>å……å€¼é‡‘é¢ (USDC)</label>
                <input type="number" id="depositAmount" placeholder="æœ€ä½100 USDC" min="100" value="100">
                <div class="amount-buttons">
                    <button class="amount-btn" data-amount="100">100</button>
                    <button class="amount-btn" data-amount="500">500</button>
                    <button class="amount-btn" data-amount="1000">1000</button>
                    <button class="amount-btn" data-amount="5000">5000</button>
                </div>
            </div>

            <button id="approveBtn" class="btn btn-primary">
                ç¬¬ä¸€æ­¥ï¼šæˆæƒUSDC
            </button>

            <button id="registerBtn" class="btn btn-primary hidden">
                ç¬¬äºŒæ­¥ï¼šæ³¨å†Œå¹¶å……å€¼
            </button>

            <button id="disconnectBtn" class="btn btn-secondary">
                æ–­å¼€é’±åŒ…
            </button>
        </div>

        <!-- å·²æ³¨å†ŒProviderä¿¡æ¯ -->
        <div id="providerSection" class="hidden">
            <div class="provider-info">
                <h3>âœ… æ‚¨å·²æ˜¯è®¤è¯Provider</h3>
                <div class="provider-stat">
                    <span>è®¤è¯ç­‰çº§</span>
                    <span class="provider-stat-value" id="providerTier">-</span>
                </div>
                <div class="provider-stat">
                    <span>æ± å†…ä½™é¢</span>
                    <span class="provider-stat-value" id="poolBalance">-</span>
                </div>
                <div class="provider-stat">
                    <span>å¯ç”¨ä½™é¢</span>
                    <span class="provider-stat-value" id="availableBalance">-</span>
                </div>
                <div class="provider-stat">
                    <span>æˆåŠŸç‡</span>
                    <span class="provider-stat-value" id="successRate">-</span>
                </div>
            </div>

            <div class="input-group">
                <label>è¿½åŠ å……å€¼ (USDC)</label>
                <input type="number" id="topupAmount" placeholder="è¾“å…¥é‡‘é¢" min="1" value="100">
            </div>

            <button id="topupBtn" class="btn btn-primary">
                è¿½åŠ å……å€¼
            </button>

            <button id="withdrawBtn" class="btn btn-secondary">
                æå–èµ„é‡‘
            </button>
        </div>

        <!-- æ¶ˆæ¯æç¤º -->
        <div id="messageBox"></div>
    </div>

    <script>
        // é…ç½®
        const CONFIG = {
            // Base Sepoliaé…ç½®
            chainId: '0x14a34', // 84532 in hex
            chainName: 'Base Sepolia',
            rpcUrl: 'https://sepolia.base.org',

            // åˆçº¦åœ°å€ï¼ˆéœ€è¦æ›¿æ¢ä¸ºå®é™…éƒ¨ç½²çš„åœ°å€ï¼‰
            INSURANCE_ADDRESS: '0x...', // TODO: æ›¿æ¢ä¸ºå®é™…åœ°å€
            USDC_ADDRESS: '0x036CbD53842c5426634e7929541eC2318f3dCF7e',

            // ABI (ç®€åŒ–ç‰ˆ)
            INSURANCE_ABI: [
                "function registerAndDeposit(uint256 amount)",
                "function deposit(uint256 amount)",
                "function withdraw(uint256 amount)",
                "function getProviderInfo(address provider) view returns (uint256 poolBalance, uint256 availableBalance, uint256 lockedBalance, uint8 tier, bool isActive, uint256 successRate)",
                "function getProviderStats(address provider) view returns (uint256 totalDeposited, uint256 totalWithdrawn, uint256 totalPenalties, uint256 successCount, uint256 failureCount, uint256 registeredAt, uint256 lastActivityAt)"
            ],

            USDC_ABI: [
                "function balanceOf(address owner) view returns (uint256)",
                "function approve(address spender, uint256 amount) returns (bool)",
                "function decimals() view returns (uint8)"
            ]
        };

        // å…¨å±€å˜é‡
        let provider = null;
        let signer = null;
        let insuranceContract = null;
        let usdcContract = null;
        let currentAccount = null;

        // å·¥å…·å‡½æ•°
        function showMessage(message, type = 'info') {
            const messageBox = document.getElementById('messageBox');
            messageBox.className = `alert alert-${type}`;
            messageBox.textContent = message;
            messageBox.style.display = 'block';

            setTimeout(() => {
                messageBox.style.display = 'none';
            }, 5000);
        }

        function formatAddress(address) {
            return `${address.slice(0, 6)}...${address.slice(-4)}`;
        }

        function updateTierBadge(amount) {
            const badges = document.querySelectorAll('.tier-badge');
            badges.forEach(badge => badge.classList.remove('active'));

            if (amount >= 5000) {
                document.querySelector('[data-tier="platinum"]').classList.add('active');
            } else if (amount >= 1000) {
                document.querySelector('[data-tier="gold"]').classList.add('active');
            } else if (amount >= 500) {
                document.querySelector('[data-tier="silver"]').classList.add('active');
            } else if (amount >= 100) {
                document.querySelector('[data-tier="bronze"]').classList.add('active');
            }
        }

        // è¿æ¥é’±åŒ…
        async function connectWallet() {
            try {
                if (!window.ethereum) {
                    showMessage('è¯·å®‰è£…MetaMaské’±åŒ…!', 'error');
                    return;
                }

                // è¯·æ±‚è¿æ¥
                const accounts = await window.ethereum.request({
                    method: 'eth_requestAccounts'
                });

                currentAccount = accounts[0];

                // åˆ‡æ¢åˆ°Base Sepoliaç½‘ç»œ
                try {
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: CONFIG.chainId }]
                    });
                } catch (switchError) {
                    // ç½‘ç»œä¸å­˜åœ¨ï¼Œæ·»åŠ ç½‘ç»œ
                    if (switchError.code === 4902) {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [{
                                chainId: CONFIG.chainId,
                                chainName: CONFIG.chainName,
                                rpcUrls: [CONFIG.rpcUrl],
                                nativeCurrency: {
                                    name: 'ETH',
                                    symbol: 'ETH',
                                    decimals: 18
                                },
                                blockExplorerUrls: ['https://sepolia.basescan.org']
                            }]
                        });
                    }
                }

                // åˆå§‹åŒ–ethers
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();

                // åˆå§‹åŒ–åˆçº¦
                insuranceContract = new ethers.Contract(
                    CONFIG.INSURANCE_ADDRESS,
                    CONFIG.INSURANCE_ABI,
                    signer
                );

                usdcContract = new ethers.Contract(
                    CONFIG.USDC_ADDRESS,
                    CONFIG.USDC_ABI,
                    signer
                );

                // æ›´æ–°UI
                await updateWalletInfo();

                // æ£€æŸ¥æ˜¯å¦å·²æ³¨å†Œ
                await checkProviderStatus();

                showMessage('é’±åŒ…è¿æ¥æˆåŠŸ!', 'success');

            } catch (error) {
                console.error(error);
                showMessage('è¿æ¥å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ›´æ–°é’±åŒ…ä¿¡æ¯
        async function updateWalletInfo() {
            document.getElementById('walletAddress').textContent = formatAddress(currentAccount);
            document.getElementById('networkName').textContent = CONFIG.chainName;

            // è·å–USDCä½™é¢
            const balance = await usdcContract.balanceOf(currentAccount);
            const decimals = await usdcContract.decimals();
            const formattedBalance = ethers.utils.formatUnits(balance, decimals);
            document.getElementById('usdcBalance').textContent = `${parseFloat(formattedBalance).toFixed(2)} USDC`;
        }

        // æ£€æŸ¥ProviderçŠ¶æ€
        async function checkProviderStatus() {
            try {
                const info = await insuranceContract.getProviderInfo(currentAccount);
                const isActive = info[4]; // isActive

                if (isActive) {
                    // å·²æ³¨å†Œï¼Œæ˜¾ç¤ºProviderä¿¡æ¯
                    const tierNames = ['None', 'Bronze', 'Silver', 'Gold', 'Platinum'];
                    const tierEmojis = ['âŒ', 'ğŸ¥‰', 'ğŸ¥ˆ', 'ğŸ¥‡', 'ğŸ’'];
                    const tier = info[3];

                    document.getElementById('providerTier').textContent =
                        `${tierEmojis[tier]} ${tierNames[tier]}`;
                    document.getElementById('poolBalance').textContent =
                        `${ethers.utils.formatUnits(info[0], 6)} USDC`;
                    document.getElementById('availableBalance').textContent =
                        `${ethers.utils.formatUnits(info[1], 6)} USDC`;
                    document.getElementById('successRate').textContent =
                        `${info[5].toString()}%`;

                    document.getElementById('connectSection').classList.add('hidden');
                    document.getElementById('registerSection').classList.add('hidden');
                    document.getElementById('providerSection').classList.remove('hidden');
                } else {
                    // æœªæ³¨å†Œï¼Œæ˜¾ç¤ºæ³¨å†Œç•Œé¢
                    document.getElementById('connectSection').classList.add('hidden');
                    document.getElementById('registerSection').classList.remove('hidden');
                    document.getElementById('providerSection').classList.add('hidden');
                }
            } catch (error) {
                // æœªæ³¨å†Œ
                document.getElementById('connectSection').classList.add('hidden');
                document.getElementById('registerSection').classList.remove('hidden');
                document.getElementById('providerSection').classList.add('hidden');
            }
        }

        // æˆæƒUSDC
        async function approveUSDC() {
            try {
                const amount = document.getElementById('depositAmount').value;
                if (amount < 100) {
                    showMessage('æœ€ä½å……å€¼é‡‘é¢ä¸º100 USDC', 'error');
                    return;
                }

                showMessage('æ­£åœ¨æˆæƒUSDC...', 'info');

                const amountWei = ethers.utils.parseUnits(amount, 6);
                const tx = await usdcContract.approve(CONFIG.INSURANCE_ADDRESS, amountWei);

                showMessage('ç­‰å¾…äº¤æ˜“ç¡®è®¤...', 'info');
                await tx.wait();

                showMessage('æˆæƒæˆåŠŸ! è¯·ç‚¹å‡»æ³¨å†ŒæŒ‰é’®', 'success');

                document.getElementById('approveBtn').classList.add('hidden');
                document.getElementById('registerBtn').classList.remove('hidden');

            } catch (error) {
                console.error(error);
                showMessage('æˆæƒå¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ³¨å†Œå¹¶å……å€¼
        async function registerAndDeposit() {
            try {
                const amount = document.getElementById('depositAmount').value;

                showMessage('æ­£åœ¨æ³¨å†Œ...', 'info');

                const amountWei = ethers.utils.parseUnits(amount, 6);
                const tx = await insuranceContract.registerAndDeposit(amountWei);

                showMessage('ç­‰å¾…äº¤æ˜“ç¡®è®¤...', 'info');
                await tx.wait();

                showMessage('ğŸ‰ æ³¨å†ŒæˆåŠŸ! æ‚¨å·²æˆä¸ºè®¤è¯Provider', 'success');

                // åˆ·æ–°çŠ¶æ€
                await checkProviderStatus();

            } catch (error) {
                console.error(error);
                showMessage('æ³¨å†Œå¤±è´¥: ' + error.message, 'error');
            }
        }

        // è¿½åŠ å……å€¼
        async function topup() {
            try {
                const amount = document.getElementById('topupAmount').value;

                showMessage('æ­£åœ¨å……å€¼...', 'info');

                const amountWei = ethers.utils.parseUnits(amount, 6);

                // å…ˆæˆæƒ
                const approveTx = await usdcContract.approve(CONFIG.INSURANCE_ADDRESS, amountWei);
                await approveTx.wait();

                // å†å……å€¼
                const tx = await insuranceContract.deposit(amountWei);
                await tx.wait();

                showMessage('å……å€¼æˆåŠŸ!', 'success');

                // åˆ·æ–°çŠ¶æ€
                await checkProviderStatus();

            } catch (error) {
                console.error(error);
                showMessage('å……å€¼å¤±è´¥: ' + error.message, 'error');
            }
        }

        // äº‹ä»¶ç›‘å¬
        document.getElementById('connectBtn').addEventListener('click', connectWallet);

        document.getElementById('disconnectBtn').addEventListener('click', () => {
            currentAccount = null;
            document.getElementById('connectSection').classList.remove('hidden');
            document.getElementById('registerSection').classList.add('hidden');
            document.getElementById('providerSection').classList.add('hidden');
            showMessage('é’±åŒ…å·²æ–­å¼€', 'info');
        });

        document.getElementById('approveBtn').addEventListener('click', approveUSDC);
        document.getElementById('registerBtn').addEventListener('click', registerAndDeposit);
        document.getElementById('topupBtn').addEventListener('click', topup);

        // é‡‘é¢å¿«æ·æŒ‰é’®
        document.querySelectorAll('.amount-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const amount = btn.dataset.amount;
                document.getElementById('depositAmount').value = amount;

                document.querySelectorAll('.amount-btn').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');

                updateTierBadge(parseInt(amount));
            });
        });

        // é‡‘é¢è¾“å…¥ç›‘å¬
        document.getElementById('depositAmount').addEventListener('input', (e) => {
            updateTierBadge(parseInt(e.target.value) || 0);
        });

        // ç›‘å¬è´¦æˆ·å˜åŒ–
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', (accounts) => {
                if (accounts.length === 0) {
                    currentAccount = null;
                    document.getElementById('connectSection').classList.remove('hidden');
                    document.getElementById('registerSection').classList.add('hidden');
                    document.getElementById('providerSection').classList.add('hidden');
                } else {
                    currentAccount = accounts[0];
                    updateWalletInfo();
                    checkProviderStatus();
                }
            });

            window.ethereum.on('chainChanged', () => {
                window.location.reload();
            });
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', () => {
            if (!CONFIG.INSURANCE_ADDRESS || CONFIG.INSURANCE_ADDRESS === '0x...') {
                showMessage('âš ï¸ è¯·å…ˆéƒ¨ç½²åˆçº¦å¹¶æ›´æ–°INSURANCE_ADDRESS', 'warning');
            }
        });
    </script>
</body>
</html>